st = `[{"date":"2022-02-07T00:00:00+0000","symbol":"NFLX","volume":8228000,"high":412.35,"low":393.55,"exchange":"XNAS","close":402.1,"open":410.17},{"date":"2022-02-04T00:00:00+0000","volume":7782400,"high":412.77,"low":396.64,"close":410.17,"open":407.31},{"date":"2022-02-03T00:00:00+0000","volume":9318383,"high":429.26,"low":404.35,"close":405.6,"open":421.44},{"date":"2022-02-02T00:00:00+0000","volume":14303000,"high":451.98,"low":426.48,"close":429.48,"open":448.25},{"date":"2022-02-01T00:00:00+0000","volume":22403233,"high":458.43,"low":425.5401,"close":457.13,"open":432.96},{"date":"2022-01-31T00:00:00+0000","volume":20025900,"high":427.7,"low":398.2,"close":427.14,"open":401.97},{"date":"2022-01-28T00:00:00+0000","volume":11957500,"high":387,"low":372.08,"close":384.36,"open":386.76},{"date":"2022-01-27T00:00:00+0000","volume":23989294,"high":394.8,"low":378.1,"close":386.7,"open":382.06},{"date":"2022-01-26T00:00:00+0000","volume":11678253,"high":382.66,"low":356.68,"close":359.7,"open":378.27},{"date":"2022-01-25T00:00:00+0000","volume":15113000,"high":387.71,"low":365.13,"close":366.42,"open":379.14},{"date":"2022-01-24T00:00:00+0000","volume":32282979,"high":387.26,"low":351.4701,"close":387.15,"open":383.91},{"date":"2022-01-21T00:00:00+0000","volume":58824800,"high":409.15,"low":379.99,"close":397.5,"open":400.43},{"date":"2022-01-20T00:00:00+0000","volume":8988324,"high":526.61,"low":506.93,"close":508.25,"open":517.7498},{"date":"2022-01-19T00:00:00+0000","volume":4200757,"high":523.21,"low":510.51,"close":515.86,"open":515},{"date":"2022-01-18T00:00:00+0000","volume":4438627,"high":521.745,"low":508.7,"close":510.8,"open":520.08},{"date":"2022-01-14T00:00:00+0000","volume":7849400,"high":538.37,"low":511.88,"close":525.69,"open":517.6},{"date":"2022-01-13T00:00:00+0000","volume":4192271,"high":540.64,"low":518.26,"close":519.2,"open":537.06},{"date":"2022-01-12T00:00:00+0000","volume":3744985,"high":544.27,"low":532.02,"close":537.22,"open":544.27},{"date":"2022-01-11T00:00:00+0000","volume":3072000,"high":543.91,"low":530.07,"close":540.84,"open":536.99},{"date":"2022-01-10T00:00:00+0000","volume":4483300,"high":543.69,"low":526.32,"close":539.85,"open":538.49},{"date":"2022-01-07T00:00:00+0000","volume":3381700,"high":553.43,"low":538.22,"close":541.06,"open":549.46},{"date":"2022-01-06T00:00:00+0000","volume":5709900,"high":563.36,"low":542.01,"close":553.29,"open":554.34},{"date":"2022-01-05T00:00:00+0000","volume":4144100,"high":592.84,"low":566.88,"close":567.52,"open":592},{"date":"2022-01-04T00:00:00+0000","volume":4163623,"high":600.4099,"low":581.6,"close":591.15,"open":599.91},{"date":"2022-01-03T00:00:00+0000","volume":3067500,"high":609.99,"low":590.56,"close":597.37,"open":605.61},{"date":"2021-12-31T00:00:00+0000","volume":1994100,"high":614.08,"low":602.05,"close":602.44,"open":610.01},{"date":"2021-12-30T00:00:00+0000","volume":1621900,"high":620.61,"low":611.24,"close":612.09,"open":612.99},{"date":"2021-12-29T00:00:00+0000","volume":1287200,"high":613.98,"low":604.68,"close":610.54,"open":610.71},{"date":"2021-12-28T00:00:00+0000","volume":1825504,"high":618.41,"low":609.69,"close":610.71,"open":614.95},{"date":"2021-12-27T00:00:00+0000","volume":2062233,"high":615,"low":609.25,"close":613.12,"open":615},{"date":"2021-12-23T00:00:00+0000","volume":1620600,"high":616.88,"low":607.57,"close":614.09,"open":616.4},{"date":"2021-12-22T00:00:00+0000","volume":2332800,"high":614.82,"low":602.63,"close":614.24,"open":603.36},{"date":"2021-12-21T00:00:00+0000","volume":2317600,"high":607.82,"low":593.86,"close":604.92,"open":597.54},{"date":"2021-12-20T00:00:00+0000","volume":3358402,"high":602.8847,"low":584.3908,"close":593.74,"open":586.43},{"date":"2021-12-17T00:00:00+0000","volume":4386900,"high":593.25,"low":581.74,"close":586.73,"open":591.61},{"date":"2021-12-16T00:00:00+0000","volume":3139900,"high":602.83,"low":588,"close":591.06,"open":597.09},{"date":"2021-12-15T00:00:00+0000","volume":2866196,"high":605.69,"low":584.51,"close":605.04,"open":598.18},{"date":"2021-12-14T00:00:00+0000","volume":2983200,"high":602.29,"low":588.13,"close":597.99,"open":598.71},{"date":"2021-12-13T00:00:00+0000","volume":2467566,"high":612.64,"low":599.52,"close":604.56,"open":612},{"date":"2021-12-10T00:00:00+0000","volume":2627194,"high":617.74,"low":605.88,"close":611.66,"open":616.78},{"date":"2021-12-09T00:00:00+0000","volume":2376321,"high":630.24,"low":610.44,"close":611,"open":627.58},{"date":"2021-12-08T00:00:00+0000","volume":2219200,"high":632.46,"low":623.2,"close":628.08,"open":630},{"date":"2021-12-07T00:00:00+0000","volume":3057462,"high":628.87,"low":611.44,"close":625.58,"open":619.83},{"date":"2021-12-06T00:00:00+0000","volume":3075672,"high":617.29,"low":601,"close":612.69,"open":606.01},{"date":"2021-12-03T00:00:00+0000","volume":4825200,"high":625.5,"low":594,"close":602.13,"open":622.75},{"date":"2021-12-02T00:00:00+0000","volume":3328500,"high":625.36,"low":612.88,"close":616.47,"open":617.1},{"date":"2021-12-01T00:00:00+0000","volume":3897019,"high":654.52,"low":617.07,"close":617.77,"open":649.48},{"date":"2021-11-30T00:00:00+0000","volume":5605300,"high":675.38,"low":640.01,"close":641.9,"open":668.2},{"date":"2021-11-29T00:00:00+0000","volume":2529364,"high":667.97,"low":658.29,"close":663.84,"open":663.2},{"date":"2021-11-26T00:00:00+0000","volume":2872500,"high":676.41,"low":660.67,"close":665.64,"open":675},{"date":"2021-11-24T00:00:00+0000","volume":1867282,"high":661.44,"low":651.1,"close":658.29,"open":658.01},{"date":"2021-11-23T00:00:00+0000","volume":2269193,"high":666.43,"low":646.17,"close":654.06,"open":658.18},{"date":"2021-11-22T00:00:00+0000","volume":2685900,"high":679.48,"low":656.48,"close":659.2,"open":676.02},{"date":"2021-11-19T00:00:00+0000","volume":2613700,"high":694.16,"low":675,"close":678.8,"open":692.35},{"date":"2021-11-18T00:00:00+0000","volume":2012900,"high":691.74,"low":679.74,"close":682.02,"open":691.61},{"date":"2021-11-17T00:00:00+0000","volume":2732831,"high":700.9894,"low":686.09,"close":691.69,"open":690},{"date":"2021-11-16T00:00:00+0000","volume":2075800,"high":688.36,"low":676.9,"close":687.4,"open":678.27},{"date":"2021-11-15T00:00:00+0000","volume":2871100,"high":685.26,"low":671.49,"close":679.33,"open":681.24},{"date":"2021-11-12T00:00:00+0000","volume":4192700,"high":683.34,"low":653.82,"close":682.61,"open":660.01},{"date":"2021-11-11T00:00:00+0000","volume":2866200,"high":665.82,"low":649.71,"close":657.58,"open":650.24},{"date":"2021-11-10T00:00:00+0000","volume":2287811,"high":660.3306,"low":642.11,"close":646.91,"open":653.01},{"date":"2021-11-09T00:00:00+0000","volume":2415630,"high":660.5,"low":650.675,"close":655.99,"open":653.7},{"date":"2021-11-08T00:00:00+0000","volume":2887523,"high":655.8792,"low":643.8,"close":651.45,"open":650.29},{"date":"2021-11-05T00:00:00+0000","volume":5277400,"high":665.64,"low":645.01,"close":645.72,"open":663.97},{"date":"2021-11-04T00:00:00+0000","volume":4863100,"high":685.94,"low":665.5,"close":668.4,"open":685.89},{"date":"2021-11-03T00:00:00+0000","volume":2334852,"high":689.39,"low":677.27,"close":688.29,"open":677.27},{"date":"2021-11-02T00:00:00+0000","volume":3887100,"high":687.68,"low":673.82,"close":677.72,"open":683.11},{"date":"2021-11-01T00:00:00+0000","volume":3110911,"high":689.57,"low":676.54,"close":681.17,"open":689.06},{"date":"2021-10-29T00:00:00+0000","volume":3817500,"high":690.97,"low":671.24,"close":690.31,"open":673.06},{"date":"2021-10-28T00:00:00+0000","volume":2855300,"high":676.8,"low":668.03,"close":674.05,"open":670.95},{"date":"2021-10-27T00:00:00+0000","volume":2276914,"high":671.41,"low":661.86,"close":662.92,"open":669},{"date":"2021-10-26T00:00:00+0000","volume":2902200,"high":676.49,"low":662.77,"close":668.52,"open":673.76},{"date":"2021-10-25T00:00:00+0000","volume":3827218,"high":675.88,"low":657.07,"close":671.66,"open":663.74},{"date":"2021-10-22T00:00:00+0000","volume":6179700,"high":665.46,"low":651.81,"close":664.78,"open":651.81},{"date":"2021-10-21T00:00:00+0000","volume":8427800,"high":654.01,"low":628.65,"close":653.16,"open":628.89},{"date":"2021-10-20T00:00:00+0000","volume":10525936,"high":637.3,"low":617.15,"close":625.14,"open":625.5728},{"date":"2021-10-19T00:00:00+0000","volume":7502000,"high":641,"low":632.3,"close":639,"open":636.97},{"date":"2021-10-18T00:00:00+0000","volume":4407973,"high":638.41,"low":620.5901,"close":637.97,"open":632.1},{"date":"2021-10-15T00:00:00+0000","volume":4116874,"high":639.42,"low":625.16,"close":628.29,"open":638},{"date":"2021-10-14T00:00:00+0000","volume":2672535,"high":636.88,"low":626.8,"close":633.8,"open":632.23},{"date":"2021-10-13T00:00:00+0000","volume":2424638,"high":632.1791,"low":622.19,"close":629.76,"open":632.179},{"date":"2021-10-12T00:00:00+0000","volume":3152931,"high":637.655,"low":621.99,"close":624.94,"open":633.02},{"date":"2021-10-11T00:00:00+0000","volume":2862470,"high":639.38,"low":626.78,"close":627.04,"open":633.195},{"date":"2021-10-08T00:00:00+0000","volume":3271100,"high":643.8,"low":630.86,"close":632.66,"open":634.17},{"date":"2021-10-07T00:00:00+0000","volume":3451046,"high":646.84,"low":630.45,"close":631.85,"open":642.225},{"date":"2021-10-06T00:00:00+0000","volume":4580434,"high":639.8699,"low":626.42,"close":639.1,"open":628.18},{"date":"2021-10-05T00:00:00+0000","volume":9534293,"high":640.39,"low":606.89,"close":634.81,"open":606.94},{"date":"2021-10-04T00:00:00+0000","volume":4904372,"high":626.125,"low":594.79,"close":603.35,"open":613.39},{"date":"2021-10-01T00:00:00+0000","volume":4089800,"high":614.99,"low":597.51,"close":613.15,"open":604.24},{"date":"2021-09-30T00:00:00+0000","volume":6616040,"high":619,"low":608.05,"close":610.34,"open":608.05},{"date":"2021-09-29T00:00:00+0000","volume":6221026,"high":609.8799,"low":588.01,"close":599.06,"open":589.01}]`

STOCK_NAME='Netflix, Inc.'
STOCK_ADDRESS='100 Winchester Cir, Los Gatos, California, United States'
STOCK_DESCRIPTION='Netflix, Inc. is an American subscription streaming service and production company. Launched on August 29, 1997, it offers a library of films and television series through distribution deals as well as its own productions, known as Netflix Originals.'

/* var upward = "rgb(17,149,8)"
var downward = "rgb(202, 29, 33)" */
firstDate = ""
lastDate = ""
earnedInTimePeriod = 0

function STDs(){

    /* st = GetURLParameter("st")
    st = st.replaceAll("%22", '"') */
    st = JSON.parse(st)
    
    st = st.reverse()

    date = new Date(st[0].date)
    firstDate = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDay()}`
    date = new Date(st[st.length-1].date)
    lastDate = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDay()}`

    earnedInTimePeriod = (st[st.length-1].close - st[0].close).toFixed(2)

    console.log(st)

    mainInfo()
    mainChart()
    theOtherChart()
}

function marqData(string){
    marqDa = document.getElementById("marqData")
    
    if(marqDa.innerHTML != ""){
        marqDa.innerHTML += " Â· "
    }
    marqDa.innerHTML += string
}

function mainInfo(){
    document.getElementById("title").innerHTML = STOCK_NAME
    document.getElementById("code").innerHTML = st[st.length - 1].symbol
    document.getElementById("exchange").innerHTML = st[st.length - 1].exchange
    document.getElementById("address").innerHTML = STOCK_ADDRESS
    document.getElementById("description").innerHTML = STOCK_DESCRIPTION
    marqData(`Last close: ${(st[st.length - 1].close).toFixed(2)}$`)
    
    repeat = true
    budget = 1
    while(repeat){
        budget *= 10
        maxHypo = maxHypotheticalHighAndSellRevenue(budget)
        if(maxHypo != budget) repeat = false
    }
    document.getElementById("maxHypo").innerHTML = `If you had marketed ${budget}$ you would have ${maxHypo}$ now.`


    if(earnedInTimePeriod >= 0){
        document.getElementById("earned").innerHTML = `In the time span the company has earned: ${earnedInTimePeriod}$.`
    } else document.getElementById("earned").innerHTML = `In the time span the company has lost: ${-earnedInTimePeriod}$.`

    document.getElementById("raiseDays").innerHTML = `The stock has risen ${raiseDaysPercentage()}% of the days in the time span.`
}

function maxHypotheticalHighAndSellRevenue(budget){
    yesterday = st[0].close
    stocks = 0
    higher = 0
    for (let i = 1; i < st.length; i++) {
        today = st[i].close
        if(today > yesterday || st.length - i < 2){
            if(stocks > 0 || st.length - i < 5){
                sellableAmount = 1
                if(higher > 0 || st.length - i < 5){
                    sellableAmount = stocks
                }
                budget += today * sellableAmount
                stocks -= sellableAmount
            }
            higher = 1
        } else if(today < yesterday){
            if(budget >= today && !st.length - i < 10){
                buyableAmount = 1
                if(higher < 0){
                    buyableAmount = Math.floor(budget / today)
                }
                budget -= today * buyableAmount
                stocks += buyableAmount
            }
            higher = -1
        } else {
            if(higher > 0 && stocks >= 0){
                budget += today
            } else if(higher < 0 && budget >= today){
                budget -= today
                stocks += 1
            }
        }

        yesterday = today
    }
    return (budget).toFixed(2)
}

function raiseDaysPercentage(){
    daysPassed = 0
    daysRaised = 0
    yesterday = st[0].close
    for (let i = 1; i < st.length; i++) {
        today = st[i].close
        if(today > yesterday) {
            daysRaised += 1
        }
        daysPassed += 1
        yesterday = today
    }
    return (daysRaised / daysPassed).toFixed(3)
}

function mainChart(){
    const ctx = document.getElementById('main-chart')

    closes = []
    opens = []
    highs = []
    lows = []
    labels = []
    max = st[0].close
    min = st[0].close

    for (let i = 0; i < st.length; i++) {
        if(max < st[i].close) max = st[i].close
        if(min > st[i].close) min = st[i].close
        closes[i] = st[i].close
        opens[i] = st[i].open
        highs[i] = st[i].high
        lows[i] = st[i].low
        date = new Date(st[i].date)
        labels[i] = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDay()}`
    }
    marqData(`MAX in time: ${max.toFixed(2)}$`)
    marqData(`MIN in time: ${min.toFixed(2)}$`)

    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Close',
                data: closes,
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            },{
                label: 'Open',
                data: opens,
                fill: false,
                borderColor: 'rgb(95, 70, 192)',
                tension: 0.1
            },{
                label: 'High',
                data: highs,
                fill: false,
                borderColor: 'rgb(14, 205, 14)',
                tension: 0.1
            },{
                label: 'Low',
                data: lows,
                fill: false,
                borderColor: 'rgb(220, 40, 70)',
                tension: 0.1
            }]
        },
        options: {
            scales: {
                x: {
                    ticks: {
                        color: 'whitesmoke'
                    }
                },
                y: {
                    ticks: {
                        color: 'whitesmoke'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'whitesmoke'
                    }
                }
            }
        }
    })
}

function theOtherChart(){
    const ctx = document.getElementById('the-other-chart')
    labels = []
    data = []
    MCVs = []

    MCVs[0] = new MCV(st[0].close, 1)
    
    for (let i = 1; i < st.length; i++){
        done = false
        for (let j = 0; j < MCVs.length; j++) {
            if(MCVs[j].value == st[i].close && !done){ 
                MCVs[j].repetitions += 1;
                done = true
            }

            if(j == MCVs.length - 1 && !done){
                MCVs[MCVs.length] = new MCV(st[i].close, 0)
            }
        }

    }

    for (let i = 0; i < MCVs.length; i++) {
        data[i] = MCVs[i].repetitions
        labels[i] = MCVs[i].value
    }

    console.log(MCVs)

    const myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Most Common Values',
                data: data,
                fill: false,
                backgroundColor: 'rgb(75, 192, 192)',
                borderColor: 'rgb(55, 172, 172)',
                borderWidth: 2,
                tension: 0.1
            }]
        },
        options: {
            scales: {
                x: {
                    ticks: {
                        color: 'whitesmoke'
                    }
                },
                y: {
                    ticks: {
                        color: 'whitesmoke'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'whitesmoke'
                    }
                }
            }
        }
    })
}

class MCV{
    constructor(value, repetitions){
        this.value = value
        this.repetitions = repetitions
    }
}

function saveAsImage(main){
    link = document.createElement('a')
    if(main){
        link.download = `${STOCK_NAME} from ${firstDate} to ${lastDate}.png`
        chart = document.getElementById('main-chart')
    } else {
        link.download = `MCV in ${STOCK_NAME} from ${firstDate} to ${lastDate}.png`
        chart = document.getElementById('the-other-chart')
    }
    link.href = chart.toDataURL()
    link.click()
    link.delete
}

function GetURLParameter(sParam)
{
    var sPageURL = window.location.search.substring(1)
    var sURLVariables = sPageURL.split('&')
    for (var i = 0; i < sURLVariables.length; i++) 
    {
        var sParameterName = sURLVariables[i].split('=')
        if (sParameterName[0] == sParam) 
        {
            return sParameterName[1]
        }
    }
}